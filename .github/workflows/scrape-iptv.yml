name: Scrape IPTV IPs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'
  push:
    paths:
      - 'scrape_iptv.py'
      - '.github/workflows/scrape-iptv.yml'

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 30

    steps:
    - name: ğŸ—‚ï¸ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        
    - name: ğŸ•·ï¸ Run scraping script
      id: scrape
      run: |
        echo "å¼€å§‹æ‰§è¡ŒæŠ“å–è„šæœ¬..."
        python scrape_iptv.py
        EXIT_CODE=$?
        echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
        echo "è„šæœ¬æ‰§è¡Œå®Œæˆï¼Œé€€å‡ºç : $EXIT_CODE"
        
        # ç»Ÿè®¡ç»“æœ
        if [ -d "tonkiang" ]; then
          TOTAL_IPS=0
          FILE_COUNT=0
          
          for file in tonkiang/*.txt; do
            if [ -f "$file" ]; then
              COUNT=$(wc -l < "$file" 2>/dev/null || echo 0)
              TOTAL_IPS=$((TOTAL_IPS + COUNT))
              FILE_COUNT=$((FILE_COUNT + 1))
            fi
          done
          
          echo "total_ips=$TOTAL_IPS" >> $GITHUB_OUTPUT
          echo "files_created=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "æ‰¾åˆ° $TOTAL_IPS ä¸ªIPï¼Œåˆ›å»º $FILE_COUNT ä¸ªæ–‡ä»¶"
        else
          echo "total_ips=0" >> $GITHUB_OUTPUT
          echo "files_created=0" >> $GITHUB_OUTPUT
          echo "æœªæ‰¾åˆ°ä»»ä½•IP"
        fi
        
    - name: ğŸ“Š Display detailed results
      run: |
        echo "=========================================="
        echo "ğŸ“ˆ è¯¦ç»†æŠ“å–ç»“æœ"
        echo "=========================================="
        echo "è„šæœ¬é€€å‡ºç : ${{ steps.scrape.outputs.exit_code }}"
        echo "æ€»IPæ•°é‡: ${{ steps.scrape.outputs.total_ips }}"
        echo "åˆ›å»ºæ–‡ä»¶æ•°: ${{ steps.scrape.outputs.files_created }}"
        echo ""
        
        # æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶
        if [ -d "tonkiang" ]; then
          echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
          find tonkiang -name "*.txt" -type f | while read file; do
            count=$(wc -l < "$file" 2>/dev/null || echo 0)
            filename=$(basename "$file")
            echo "  ğŸ“„ $filename ($count ä¸ªIP)"
          done
        else
          echo "âŒ tonkiang ç›®å½•ä¸å­˜åœ¨"
        fi
        
        # æ˜¾ç¤ºè°ƒè¯•æ–‡ä»¶
        if ls page_*_debug.html 1> /dev/null 2>&1; then
          echo ""
          echo "ğŸ› è°ƒè¯•æ–‡ä»¶:"
          ls -la page_*_debug.html
        fi
        
        echo ""
        echo "â° å·¥ä½œæµæ‰§è¡Œæ—¶é—´: $(date)"
        
    - name: ğŸ’¾ Commit and push if successful
      if: steps.scrape.outputs.total_ips > 0
      run: |
        echo "å‡†å¤‡æäº¤æ›´æ”¹..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git status
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff-index --quiet HEAD --; then
          echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
        else
          git commit -m "ğŸ¤– Auto-update: æŠ“å– ${{ steps.scrape.outputs.total_ips }} ä¸ªIPï¼Œåˆ›å»º ${{ steps.scrape.outputs.files_created }} ä¸ªæ–‡ä»¶ [$(date +'%Y-%m-%d %H:%M')]"
          echo "æäº¤å®Œæˆï¼Œå‡†å¤‡æ¨é€..."
          git push
          echo "âœ… æ›´æ”¹å·²æ¨é€åˆ°ä»“åº“"
        fi
        
    - name: ğŸ§¹ Clean up debug files
      if: always()
      run: |
        echo "æ¸…ç†è°ƒè¯•æ–‡ä»¶..."
        rm -f page_*_debug.html SCRAPE_FAILED.txt
        echo "âœ… è°ƒè¯•æ–‡ä»¶æ¸…ç†å®Œæˆ"
        
    - name: ğŸ“ Create summary
      if: always()
      run: |
        echo "## IPTVæŠ“å–ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ‰§è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æŠ“å–ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "- **æ€»IPæ•°é‡:** ${{ steps.scrape.outputs.total_ips }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ›å»ºæ–‡ä»¶æ•°:** ${{ steps.scrape.outputs.files_created }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è„šæœ¬é€€å‡ºç :** ${{ steps.scrape.outputs.exit_code }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.scrape.outputs.total_ips }}" -gt 0 ]; then
          echo "âœ… **çŠ¶æ€:** æŠ“å–æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **çŠ¶æ€:** æŠ“å–å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å¯èƒ½çš„åŸå› :**" >> $GITHUB_STEP_SUMMARY
          echo "1. ç½‘ç«™Cloudflareé˜²æŠ¤" >> $GITHUB_STEP_SUMMARY
          echo "2. ç½‘ç»œè¿æ¥é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          echo "3. ç½‘ç«™ç»“æ„å˜åŒ–" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: âŒ Fail if no IPs found
      if: steps.scrape.outputs.total_ips == 0
      run: |
        echo "=========================================="
        echo "âŒ æœ¬æ¬¡æŠ“å–æ²¡æœ‰æ‰¾åˆ°ä»»ä½•IPåœ°å€"
        echo "=========================================="
        echo ""
        echo "é—®é¢˜åˆ†æ:"
        echo "1. ğŸ”’ ç½‘ç«™å¯èƒ½æœ‰å¼ºå¤§çš„Cloudflareé˜²æŠ¤"
        echo "2. ğŸŒ GitHub Actionsçš„IPå¯èƒ½è¢«å°é”"
        echo "3. ğŸ—ï¸ ç½‘ç«™HTMLç»“æ„å¯èƒ½å·²å‘ç”Ÿå˜åŒ–"
        echo "4. âš¡ ç½‘ç»œè¿æ¥æˆ–è¶…æ—¶é—®é¢˜"
        echo ""
        echo "å»ºè®®è§£å†³æ–¹æ¡ˆ:"
        echo "1. å°è¯•åœ¨å…¶ä»–ç¯å¢ƒè¿è¡Œï¼ˆå¦‚æœ¬åœ°æœºå™¨ï¼‰"
        echo "2. ä½¿ç”¨ä»£ç†æœåŠ¡å™¨"
        echo "3. æ›´æ¢å…¶ä»–IPTVæ•°æ®æº"
        echo "4. è”ç³»ç½‘ç«™ç®¡ç†å‘˜è·å–API"
        echo ""
        echo "è¯¦ç»†æ—¥å¿—è¯·æŸ¥çœ‹ä¸Šé¢çš„æ­¥éª¤è¾“å‡º"
        exit 1
