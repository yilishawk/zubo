<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV频道配置 | kakaxi</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=-apple-system,BlinkMacSystemFont,San+Francisco,Helvetica+Neue,Helvetica,Arial,sans-serif">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Helvetica Neue", Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }

        body {
            background-color: #f5f5f7;
            padding: 20px;
            color: #1d1d1f;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .panel-header {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            text-align: center;
        }
        .panel-title {
            font-size: 20px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .tab-group {
            display: flex;
            gap: 8px;
            background: #fff;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #f5f5f7;
            color: #86868b;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: #007aff;
            color: #fff;
        }

        #categories-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            cursor: grab;
        }
        #categories-container:active {
            cursor: grabbing;
        }

        .category-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid transparent;
            transition: border 0.2s;
        }
        .category-card.active {
            border: 2px solid #007aff;
        }
        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .category-name-input {
            width: 220px;
            padding: 10px 14px;
            border: 1px solid #e5e5e7;
            border-radius: 10px;
            font-size: 16px;
            color: #1d1d1f;
            background-color: #f9f9fb;
            outline: none;
            cursor: text;
        }
        .category-name-input:focus {
            border-color: #007aff;
        }
        .btn-delete {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            background-color: #ff3b30;
            color: #ffffff;
            cursor: pointer;
        }

        .channel-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            cursor: grab;
        }
        .channel-tags:active {
            cursor: grabbing;
        }
        .channel-tag {
            background-color: #e8f0fe;
            color: #007aff;
            padding: 8px 14px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: move;
        }
        .tag-close {
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }
        .tag-close:hover {
            color: #ff3b30;
        }

        .global-channel-library {
            background: #ffffff;
            border-radius: 16px;
            padding: 12px 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .library-title {
            font-size: 14px;
            color: #86868b;
            margin-bottom: 8px;
            font-weight: 400;
        }
        .preset-channels {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }
        .preset-channel {
            background-color: #f5f5f7;
            color: #1d1d1f;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            line-height: 1.2;
            min-width: 60px;
            text-align: center;
        }
        .preset-channel:hover {
            background-color: #e8f0fe;
            color: #007aff;
            transform: translateY(-1px);
        }

        .btn-group {
            display: flex;
            gap: 12px;
        }
        .btn-add-category {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            border: 1px solid #007aff;
            background-color: #ffffff;
            color: #007aff;
            cursor: pointer;
        }
        .btn-save {
            flex: 2;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            border: none;
            background-color: #007aff;
            color: #ffffff;
            cursor: pointer;
        }
        .btn-save:disabled {
            background-color: #86868b;
            cursor: not-allowed;
        }

        #mapping-panel {
            display: none;
        }
        .mapping-card {
            background: #fff;
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 12px;
        }
        .mapping-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .standard-name-input {
            width: 220px;
            padding: 10px 14px;
            border: 1px solid #e5e5e7;
            border-radius: 10px;
            font-size: 16px;
            color: #1d1d1f;
            background-color: #f9f9fb;
            outline: none;
            cursor: text;
        }
        .standard-name-input:focus {
            border-color: #007aff;
        }
        .alias-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .alias-tag {
            background-color: #f0f8ff;
            color: #0066cc;
            padding: 8px 14px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .alias-input-container {
            display: flex;
            gap: 8px;
        }
        .alias-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #e5e5e7;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
        }
        .add-alias-btn {
            padding: 0 16px;
            border-radius: 10px;
            border: none;
            background: #007aff;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
        }
        .btn-add-mapping {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            border: 1px solid #007aff;
            background-color: #ffffff;
            color: #007aff;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 12px;
            width: 80%;
            max-width: 400px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #e5e5e7;
            border-radius: 10px;
            font-size: 16px;
            color: #1d1d1f;
            background-color: #f9f9fb;
            outline: none;
        }
        .modal-content button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: #007aff;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel-header">
            <h1 class="panel-title">IPTV频道配置 | kakaxi</h1>
        </div>

        <div class="tab-group">
            <button class="tab-btn active" onclick="switchTab('category')">分类配置</button>
            <button class="tab-btn" onclick="switchTab('mapping')">映射配置</button>
        </div>

        <div id="category-panel">
            <div id="categories-container">
            </div>

            <div class="global-channel-library">
                <div class="library-title">频道库（单点添加）</div>
                <div class="preset-channels" id="preset-channels-container">
                </div>
            </div>

            <div class="btn-group">
                <button id="add-category" class="btn-add-category">添加分类</button>
                <button id="save-all" class="btn-save">保存IPTV频道配置</button>
            </div>
        </div>

        <div id="mapping-panel">
            <div id="mapping-container"></div>

            <div class="btn-group">
                <button id="add-mapping" class="btn-add-mapping" onclick="openAddMappingModal()">添加映射规则</button>
                <button id="save-mapping" class="btn-save">保存映射配置</button>
            </div>
        </div>
    </div>

    <div id="addMappingModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddMappingModal()">&times;</span>
            <h3 style="margin-bottom: 15px; text-align: center;">添加映射规则</h3>
            <div class="form-group">
                <label>频道名称（主名称）：</label>
                <input type="text" id="newMappingName" placeholder="标准名" required>
            </div>
            <div class="form-group">
                <label>别名（多个用英文逗号分隔）：</label>
                <input type="text" id="newMappingAliases" placeholder="别名" required>
            </div>
            <button onclick="saveNewMapping()">保存</button>
        </div>
    </div>

    <script>
        const CATEGORY_DATA = {
            "央视频道": ["CCTV1", "CCTV2", "CCTV3", "CCTV4", "CCTV4欧洲", "CCTV4美洲", "CCTV5", "CCTV5+", "CCTV6", "CCTV7", "CCTV8", "CCTV9", 
                          "CCTV10", "CCTV11", "CCTV12", "CCTV13", "CCTV14", "CCTV15", "CCTV16", "CCTV17", "兵器科技", "风云音乐", "风云足球", "风云剧场", 
                          "怀旧剧场", "第一剧场", "女性时尚", "世界地理", "央视台球", "高尔夫网球", "央视文化精品", "卫生健康", "电视指南", "老故事", "中学生", 
                          "发现之旅", "书法频道", "国学频道", "环球奇观"],
            "卫视频道": ["湖南卫视", "浙江卫视", "江苏卫视", "东方卫视", "深圳卫视", "北京卫视", "广东卫视", "广西卫视", "东南卫视", "海南卫视", "河北卫视", 
                          "河南卫视", "湖北卫视", "江西卫视", "四川卫视", "重庆卫视", "贵州卫视", "云南卫视", "天津卫视", "安徽卫视", "山东卫视", "辽宁卫视", 
                          "黑龙江卫视", "吉林卫视", "内蒙古卫视", "宁夏卫视", "山西卫视", "陕西卫视", "甘肃卫视", "青海卫视", "新疆卫视", "西藏卫视", "三沙卫视", 
                          "兵团卫视", "延边卫视", "安多卫视", "康巴卫视", "农林卫视", "山东教育卫视", "中国教育1台", "中国教育2台", "中国教育3台", "中国教育4台", 
                          "早期教育"],
            "数字频道": ["CHC动作电影", "CHC家庭影院", "CHC影迷电影", "重温经典", "星空卫视", "CHANNELV", "凤凰卫视中文台", "凤凰卫视资讯台", "凤凰卫视香港台", 
                          "凤凰卫视电影台", "求索纪录", "求索科学", "求索生活", "求索动物", "纪实人文", "金鹰纪实", "纪实科教", "魅力足球", "五星体育", "劲爆体育", 
                          "快乐垂钓", "茶频道", "先锋乒羽", "天元围棋", "汽摩", "梨园频道", "文物宝库", "武术世界", "乐游", "生活时尚", "都市剧场", "欢笑剧场", 
                          "游戏风云", "金色学堂", "动漫秀场", "新动漫", "卡酷少儿", "金鹰卡通", "优漫卡通", "哈哈炫动", "嘉佳卡通", "中国交通", "中国天气"]
        };

        const MAPPING_DATA = {
            "CCTV1": ["CCTV-1", "CCTV1-综合", "CCTV-1 综合", "CCTV-1综合", "CCTV1HD", "CCTV-1高清", "CCTV-1HD", "cctv-1HD", "CCTV1综合高清", "cctv1"],
            "CCTV2": ["CCTV-2", "CCTV2-财经", "CCTV-2 财经", "CCTV-2财经", "CCTV2HD", "CCTV-2高清", "CCTV-2HD", "cctv-2HD", "CCTV2财经高清", "cctv2"],
            "CCTV3": ["CCTV-3", "CCTV3-综艺", "CCTV-3 综艺", "CCTV-3综艺", "CCTV3HD", "CCTV-3高清", "CCTV-3HD", "cctv-3HD", "CCTV3综艺高清", "cctv3"],
            "CCTV4": ["CCTV-4", "CCTV4-国际", "CCTV-4 中文国际", "CCTV-4中文国际", "CCTV4HD", "cctv4HD", "CCTV-4HD", "cctv-4HD", "CCTV4国际高清", "cctv4"],
            "CCTV4欧洲": ["CCTV4欧洲", "CCTV-4欧洲", "CCTV4-中文国际欧洲版", "CCTV-4 欧洲"],
            "CCTV4美洲": ["CCTV4美洲", "CCTV-4美洲", "CCTV4-中文国际美洲版", "CCTV-4 美洲"],
            "CCTV5": ["CCTV-5", "CCTV5-体育", "CCTV-5 体育", "CCTV-5体育", "CCTV5HD", "CCTV-5高清", "CCTV-5HD", "cctv-5HD", "CCTV5体育高清", "cctv5"],
            "CCTV5+": ["CCTV-5+", "CCTV-5+ HD", "CCTV-5+ 体育赛事", "CCTV5+体育赛事", "CCTV5+HD", "CCTV-5+高清", "CCTV-5+HD", "cctv-5+HD", "CCTV5plas", "CCTV5+体育赛视高清", "cctv5+"],
            "CCTV6": ["CCTV-6", "CCTV6-电影", "CCTV-6 电影", "CCTV-6电影", "CCTV6HD", "CCTV-6高清", "CCTV-6HD", "cctv-6HD", "CCTV6电影高清", "cctv6"],
            "CCTV7": ["CCTV-7", "CCTV7-军农", "CCTV-7 国防军事", "CCTV-7国防军事", "CCTV7HD", "CCTV-7高清", "CCTV-7HD", "cctv-7HD", "CCTV7军事高清", "cctv7"],
            "CCTV8": ["CCTV-8", "CCTV8-电视剧", "CCTV-8 电视剧", "CCTV-8电视剧", "CCTV8HD", "CCTV-8高清", "CCTV-8HD", "cctv-8HD", "CCTV8电视剧高清", "cctv8"],
            "CCTV9": ["CCTV-9", "CCTV9-纪录", "CCTV-9 纪录", "CCTV-9纪录", "CCTV9HD", "CCTV-9高清", "CCTV-9HD", "cctv-9HD", "CCTV9纪录高清", "cctv9"],
            "CCTV10": ["CCTV-10", "CCTV10-科教", "CCTV-10 科教", "CCTV-10科教", "CCTV10HD", "CCTV-10高清", "CCTV-10HD", "cctv-10HD", "CCTV10科教高清", "cctv10"],
            "CCTV11": ["CCTV-11", "CCTV11-戏曲", "CCTV-11 戏曲", "CCTV-11戏曲", "CCTV11HD", "CCTV-11高清", "CCTV-11HD", "cctv-11HD", "CCTV11戏曲高清", "cctv11"],
            "CCTV12": ["CCTV-12", "CCTV12-社会与法", "CCTV-12 社会与法", "CCTV-12社会与法", "CCTV12HD", "CCTV-12高清", "CCTV-12HD", "cctv-12HD", "CCTV12社会与法高清", "cctv12"],
            "CCTV13": ["CCTV-13", "CCTV13-新闻", "CCTV-13 新闻", "CCTV-13新闻", "CCTV13HD", "CCTV-13高清", "CCTV-13HD", "cctv-13HD", "CCTV13新闻高清", "cctv13"],
            "CCTV14": ["CCTV-14", "CCTV14-少儿", "CCTV-14 少儿", "CCTV-14少儿", "CCTV14HD", "CCTV-14高清", "CCTV-14HD", "cctv-14HD", "CCTV14少儿高清", "cctv14"],
            "CCTV15": ["CCTV-15", "CCTV15-音乐", "CCTV-15 音乐", "CCTV-15音乐", "CCTV15HD", "CCTV-15高清", "CCTV-15HD", "cctv-15HD", "CCTV15音乐高清", "cctv15"],
            "CCTV16": ["CCTV-16", "CCTV16-奥林匹克", "CCTV-16 奥林匹克", "CCTV16HD", "CCTV-16高清", "cctv16"],
            "CCTV17": ["CCTV-17", "CCTV17-农业农村", "CCTV-17 农业农村", "CCTV17HD", "CCTV-17高清", "cctv17"],
            "兵器科技": ["CCTV兵器高清", "CCTV兵器科技", "兵器科技频道"],
            "风云音乐": ["CCTV风云音乐高清", "CCTV风云音乐", "风云音乐频道"],
            "风云足球": ["CCTV风云足球高清", "CCTV风云足球", "风云足球频道"],
            "风云剧场": ["CCTV风云剧场高清", "CCTV风云剧场", "风云剧场频道"],
            "怀旧剧场": ["CCTV怀旧剧场高清", "CCTV怀旧剧场", "怀旧剧场频道"],
            "第一剧场": ["CCTV第一剧场高清", "CCTV第一剧场", "第一剧场频道"],
            "女性时尚": ["CCTV女性时尚高清", "CCTV女性时尚", "女性时尚频道"],
            "世界地理": ["CCTV世界地理高清", "CCTV世界地理", "世界地理频道"],
            "央视台球": ["CCTV央视台球高清", "CCTV台球频道"],
            "高尔夫网球": ["CCTV高尔夫网球高清", "CCTV高尔夫·网球", "高尔夫·网球频道"],
            "央视文化精品": ["央视文化精品", "CCTV文化精品频道", "央视文化", "文化精品"],
            "卫生健康": ["卫生健康", "CCTV卫生健康频道"],
            "电视指南": ["电视指南", "CCTV电视指南频道"],
            "老故事": ["老故事", "CCTV老故事频道"],
            "中学生": ["中学生", "CCTV中学生频道"],
            "发现之旅": ["发现之旅", "CCTV发现之旅频道"],
            "书法频道": ["书法频道", "CCTV书法频道"],
            "国学频道": ["国学频道", "CCTV国学频道"],
            "环球奇观": ["环球奇观", "CCTV环球奇观频道"],
            "湖南卫视": ["湖南卫视", "湖南卫视高清", "湖南卫视HD"],
            "浙江卫视": ["浙江卫视", "浙江卫视HD", "浙江卫视高清"],
            "江苏卫视": ["江苏卫视", "江苏卫视hd", "江苏卫视高清"],
            "东方卫视": ["东方卫视", "东方卫视hd", "上海卫视", "东方卫视高清"],
            "深圳卫视": ["深圳卫视", "深圳卫视hd", "深圳卫视高清"],
            "北京卫视": ["北京卫视", "北京卫视hd", "北京卫视高清"],
            "广东卫视": ["广东卫视", "广东卫视hd", "广东卫视高清"],
            "广西卫视": ["广西卫视", "广西卫视hd", "广西卫视高清"],
            "东南卫视": ["东南卫视", "福建东南卫视", "福建东南", "东南卫视高清"],
            "海南卫视": ["海南卫视", "海南卫视hd", "旅游卫视", "海南卫视高清"],
            "河北卫视": ["河北卫视", "河北卫视hd", "河北卫视高清"],
            "河南卫视": ["河南卫视", "河南卫视hd", "河南卫视高清"],
            "湖北卫视": ["湖北卫视", "湖北卫视hd", "湖北卫视高清"],
            "江西卫视": ["江西卫视", "江西卫视hd", "江西卫视高清"],
            "四川卫视": ["四川卫视", "四川卫视hd", "四川卫视高清"],
            "重庆卫视": ["重庆卫视", "重庆卫视hd", "重庆卫视高清"],
            "贵州卫视": ["贵州卫视", "贵州卫视hd", "贵州卫视高清"],
            "云南卫视": ["云南卫视", "云南卫视hd", "云南卫视高清"],
            "天津卫视": ["天津卫视", "天津卫视hd", "天津卫视高清"],
            "安徽卫视": ["安徽卫视", "安徽卫视hd", "安徽卫视高清"],
            "山东卫视": ["山东卫视", "山东卫视hd", "山东卫视高清"],
            "辽宁卫视": ["辽宁卫视", "辽宁卫视hd", "辽宁卫视高清"],
            "黑龙江卫视": ["黑龙江卫视", "黑龙江卫视hd", "黑龙江卫视高清"],
            "吉林卫视": ["吉林卫视", "吉林卫视hd", "吉林卫视高清"],
            "内蒙古卫视": ["内蒙古卫视", "内蒙古卫视hd", "内蒙古卫视高清"],
            "宁夏卫视": ["宁夏卫视", "宁夏卫视hd", "宁夏卫视sd"],
            "山西卫视": ["山西卫视", "山西卫视hd", "山西卫视sd"],
            "陕西卫视": ["陕西卫视", "陕西卫视hd", "陕西卫视高清"],
            "甘肃卫视": ["甘肃卫视高清", "甘肃卫视hd", "甘肃卫视sd"],
            "青海卫视": ["青海卫视高清", "青海卫视hd", "青海卫视sd"],
            "新疆卫视": ["新疆卫视", "新疆卫视sd"],
            "西藏卫视": ["西藏卫视", "西藏卫视sd"],
            "三沙卫视": ["三沙卫视高清", "三沙卫视hd"],
            "兵团卫视": ["兵团卫视", "新疆兵团卫视"],
            "延边卫视": ["延边卫视", "延边电视台"],
            "安多卫视": ["安多卫视", "安多电视台"],
            "康巴卫视": ["康巴卫视", "康巴电视台"],
            "农林卫视": ["农林卫视", "陕西农林卫视"],
            "山东教育卫视": ["山东教育", "山东教育卫视sd"],
            "中国教育1台": ["中国教育1台", "CETV1", "教育1台"],
            "中国教育2台": ["中国教育2台", "CETV2", "教育2台"],
            "中国教育3台": ["中国教育3台", "CETV3", "教育3台"],
            "中国教育4台": ["中国教育4台", "CETV4", "教育4台"],
            "早期教育": ["早期教育", "CETV早期教育频道"],
            "CHC动作电影": ["CHC动作电影", "CHC动作", "CHC动作电影高清"],
            "CHC家庭影院": ["CHC家庭影院", "CHC家庭", "CHC家庭电影高清"],
            "CHC影迷电影": ["CHC高清电影", "CHC-影迷电影", "影迷电影", "chc高清电影"],
            "重温经典": ["重温经典", "重温经典频道"],
            "星空卫视": ["星空卫视", "Star TV", "星空台"],
            "CHANNELV": ["Channel [V]", "Channel[V]"],
            "凤凰卫视中文台": ["凤凰中文", "凤凰中文台", "凤凰卫视中文", "凤凰卫视"],
            "凤凰卫视资讯台": ["凤凰资讯", "凤凰资讯台", "凤凰咨询", "凤凰咨询台", "凤凰卫视咨询台", "凤凰卫视资讯", "凤凰卫视咨询"],
            "凤凰卫视香港台": ["凤凰香港台", "凤凰卫视香港", "凤凰香港"],
            "凤凰卫视电影台": ["凤凰卫视电影台", "凤凰电影台"],
            "求索纪录": ["求索纪录", "求索纪录频道"],
            "求索科学": ["求索科学", "求索科学频道"],
            "求索生活": ["求索生活", "求索生活频道"],
            "求索动物": ["求索动物", "求索动物频道"],
            "纪实人文": ["纪实人文", "纪实人文频道"],
            "金鹰纪实": ["金鹰纪实", "金鹰纪实频道"],
            "纪实科教": ["纪实科教", "纪实科教频道"],
            "魅力足球": ["魅力足球", "魅力足球频道"],
            "五星体育": ["五星体育", "上海五星体育"],
            "劲爆体育": ["劲爆体育", "劲爆体育频道"],
            "快乐垂钓": ["快乐垂钓", "快乐垂钓频道"],
            "茶频道": ["茶频道", "茶文化频道"],
            "先锋乒羽": ["先锋乒羽", "先锋乒羽频道"],
            "天元围棋": ["天元围棋", "天元围棋频道"],
            "汽摩": ["汽摩频道", "汽车摩托车频道"],
            "梨园频道": ["梨园频道", "戏曲梨园频道"],
            "文物宝库": ["文物宝库", "文物宝库频道"],
            "武术世界": ["武术世界", "武术世界频道"],
            "乐游": ["乐游频道", "旅游频道"],
            "生活时尚": ["生活时尚", "生活时尚频道"],
            "都市剧场": ["都市剧场", "都市剧场频道"],
            "欢笑剧场": ["欢笑剧场", "欢笑剧场频道"],
            "游戏风云": ["游戏风云", "游戏风云频道"],
            "金色学堂": ["金色学堂", "金色学堂频道"],
            "动漫秀场": ["动漫秀场", "动漫秀场频道"],
            "新动漫": ["新动漫", "新动漫频道"],
            "卡酷少儿": ["卡酷少儿", "北京卡酷少儿"],
            "金鹰卡通": ["金鹰卡通", "湖南金鹰卡通"],
            "优漫卡通": ["优漫卡通", "江苏优漫卡通"],
            "哈哈炫动": ["哈哈炫动", "上海哈哈炫动"],
            "嘉佳卡通": ["嘉佳卡通", "广东嘉佳卡通"],
            "中国交通": ["中国交通", "中国交通频道"],
            "中国天气": ["中国天气", "中国天气频道"]
        };

        let ALL_CHANNELS = [];
        Object.values(CATEGORY_DATA).forEach(channels => {
            ALL_CHANNELS = [...ALL_CHANNELS, ...channels];
        });
        ALL_CHANNELS = [...new Set(ALL_CHANNELS)];

        let activeCategoryName = null;
        let mappingData = { ...MAPPING_DATA };
        let categoryData = { ...CATEGORY_DATA };
        let mappingChanged = false;

        window.onload = async function() {
            try {
                const res = await fetch('/api/config', { method: 'GET' });
                const data = await res.json();
                if (data.code === 200 && data.data) {
                    if (data.data.categories) {
                        categoryData = data.data.categories;
                        ALL_CHANNELS = [];
                        Object.values(categoryData).forEach(channels => {
                            ALL_CHANNELS = [...ALL_CHANNELS, ...channels];
                        });
                        ALL_CHANNELS = [...new Set(ALL_CHANNELS)];
                    }
                    if (data.data.mapping) {
                        mappingData = data.data.mapping;
                    }
                }
            } catch (err) {
                console.log('加载后端配置失败，使用本地默认配置:', err);
            }

            renderCategories();
            renderChannelLibrary();
            initSortable();
        };

        function initSortable() {
            const categoryContainer = document.getElementById('categories-container');
            new Sortable(categoryContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: () => {
                    const newCategoryData = {};
                    document.querySelectorAll('.category-card').forEach(card => {
                        const catName = card.dataset.name;
                        newCategoryData[catName] = categoryData[catName];
                    });
                    categoryData = newCategoryData;
                }
            });

            document.querySelectorAll('.channel-tags').forEach(tagsContainer => {
                new Sortable(tagsContainer, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: (e) => {
                        const catName = tagsContainer.closest('.category-card').dataset.name;
                        const newChannels = [];
                        tagsContainer.querySelectorAll('.channel-tag').forEach(tag => {
                            const channelName = tag.textContent.replace('×', '').trim();
                            newChannels.push(channelName);
                        });
                        categoryData[catName] = newChannels;
                    }
                });
            });
        }

        function renderCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';
            
            Object.entries(categoryData).forEach(([catName, channels]) => {
                const isActive = catName === activeCategoryName;
                const categoryHtml = `
                    <div class="category-card ${isActive ? 'active' : ''}" data-name="${catName}">
                        <div class="category-header">
                            <input type="text" class="category-name-input" value="${catName}" placeholder="比如:央视、卫视、地方等" onchange="updateCategoryName('${catName}', this.value)">
                            <button class="btn-delete" onclick="deleteCategory('${catName}')">删除</button>
                        </div>
                        <div class="channel-tags">
                            ${channels.map(channel => `
                                <div class="channel-tag">
                                    ${channel} <span class="tag-close" onclick="removeChannelFromCategory('${catName}', '${channel}')">×</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', categoryHtml);
            });

            bindCategoryActiveEvent();
            setTimeout(() => initSortable(), 0);
        }

        function bindCategoryActiveEvent() {
            document.querySelectorAll('.category-card').forEach(card => {
                card.onclick = (e) => {
                    if (e.target.classList.contains('btn-delete') || e.target.classList.contains('category-name-input')) {
                        return;
                    }
                    
                    document.querySelectorAll('.category-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    activeCategoryName = card.dataset.name;
                };
            });
        }

        function updateCategoryName(oldCatName, newName) {
            newName = newName.trim();
            if (!newName) {
                alert('分类名称不能为空');
                document.querySelector(`.category-card[data-name="${oldCatName}"] .category-name-input`).value = oldCatName;
                return;
            }
            if (newName === oldCatName) return;
            if (categoryData[newName]) {
                alert(`分类名称 "${newName}" 已存在`);
                document.querySelector(`.category-card[data-name="${oldCatName}"] .category-name-input`).value = oldCatName;
                return;
            }

            categoryData[newName] = categoryData[oldCatName];
            delete categoryData[oldCatName];
            if (activeCategoryName === oldCatName) {
                activeCategoryName = newName;
            }
            renderCategories();
        }

        function deleteCategory(catName) {
            const categoryCount = Object.keys(categoryData).length;
            if (categoryCount <= 1) {
                alert('至少保留1个分类');
                return;
            }
            if (!confirm(`确定删除分类 "${catName}" 吗？`)) {
                return;
            }

            delete categoryData[catName];
            if (activeCategoryName === catName) {
                activeCategoryName = Object.keys(categoryData)[0] || null;
            }
            renderCategories();
        }

        function removeChannelFromCategory(catName, channelName) {
            categoryData[catName] = categoryData[catName].filter(chan => chan !== channelName);
            renderCategories();
        }

        document.getElementById('add-category').addEventListener('click', () => {
            let newCatName = '新分类';
            let i = 1;
            while (categoryData[newCatName]) {
                newCatName = `新分类${i}`;
                i++;
            }
            categoryData[newCatName] = [];
            activeCategoryName = newCatName;
            renderCategories();
            const newCard = document.querySelector(`.category-card[data-name="${newCatName}"]`);
            newCard.querySelector('.category-name-input').focus();
        });

        function renderChannelLibrary() {
            const container = document.getElementById('preset-channels-container');
            container.innerHTML = '';
            
            ALL_CHANNELS.forEach(channel => {
                const channelHtml = `
                    <span class="preset-channel" onclick="addChannelToActiveCategory('${channel}')">
                        ${channel}
                    </span>
                `;
                container.insertAdjacentHTML('beforeend', channelHtml);
            });
        }

        function addChannelToActiveCategory(channelName) {
            if (!activeCategoryName) {
                alert('请先选择一个分类');
                return;
            }
            
            const channels = categoryData[activeCategoryName];
            if (channels.includes(channelName)) {
                alert(`该分类已包含频道 "${channelName}"`);
                return;
            }
            
            categoryData[activeCategoryName].push(channelName);
            renderCategories();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
            
            if (tab === 'category') {
                document.getElementById('category-panel').style.display = 'block';
                document.getElementById('mapping-panel').style.display = 'none';
            } else {
                document.getElementById('category-panel').style.display = 'none';
                document.getElementById('mapping-panel').style.display = 'block';
                renderMappings();
            }
        }

        function renderMappings() {
            const container = document.getElementById('mapping-container');
            container.innerHTML = '';
            
            Object.entries(mappingData).forEach(([stdName, aliases]) => {
                const mappingCard = document.createElement('div');
                mappingCard.className = 'mapping-card';
                mappingCard.innerHTML = `
                    <div class="mapping-header">
                        <input type="text" class="standard-name-input" value="${stdName}" placeholder="标准频道名" onchange="updateStdName('${stdName}', this.value)">
                        <button class="btn-delete" onclick="deleteMapping('${stdName}')">删除</button>
                    </div>
                    <div class="alias-tags" id="aliases-${stdName}">
                        ${aliases.map(alias => `
                            <div class="alias-tag">
                                ${alias} <span class="tag-close" onclick="removeAlias('${stdName}', '${alias}')">×</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="alias-input-container">
                        <input type="text" class="alias-input" id="alias-input-${stdName}" placeholder="输入别名">
                        <button class="add-alias-btn" onclick="addAlias('${stdName}')">添加别名</button>
                    </div>
                `;
                container.appendChild(mappingCard);
            });
        }

        function addAlias(stdName) {
            const input = document.getElementById(`alias-input-${stdName}`);
            const alias = input.value.trim();
            
            if (!alias) {
                alert('别名不能为空');
                return;
            }
            
            if (mappingData[stdName].includes(alias)) {
                alert('该别名已存在');
                return;
            }
            
            mappingData[stdName].push(alias);
            input.value = '';
            mappingChanged = true;
            
            const aliasContainer = document.getElementById(`aliases-${stdName}`);
            aliasContainer.innerHTML += `
                <div class="alias-tag">
                    ${alias} <span class="tag-close" onclick="removeAlias('${stdName}', '${alias}')">×</span>
                </div>
            `;
        }

        function removeAlias(stdName, alias) {
            mappingData[stdName] = mappingData[stdName].filter(a => a !== alias);
            mappingChanged = true;
            renderMappings();
        }

        function updateStdName(oldName, newName) {
            newName = newName.trim();
            if (!newName) {
                alert('标准频道名不能为空');
                document.querySelector(`input[onchange="updateStdName('${oldName}', this.value)"]`).value = oldName;
                return;
            }
            
            if (newName === oldName) return;
            
            if (mappingData[newName]) {
                alert(`标准频道名 "${newName}" 已存在`);
                document.querySelector(`input[onchange="updateStdName('${oldName}', this.value)"]`).value = oldName;
                return;
            }
            
            mappingData[newName] = mappingData[oldName];
            delete mappingData[oldName];
            
            ALL_CHANNELS = ALL_CHANNELS.map(chan => chan === oldName ? newName : chan);
            Object.keys(categoryData).forEach(catName => {
                categoryData[catName] = categoryData[catName].map(chan => chan === oldName ? newName : chan);
            });
            
            renderChannelLibrary();
            renderCategories();
            renderMappings();
            
            mappingChanged = true;
        }

        function deleteMapping(stdName) {
            if (!confirm(`确定删除标准频道 "${stdName}" 的映射规则并移除频道库中的该频道吗？`)) {
                return;
            }
            delete mappingData[stdName];
            mappingChanged = true;
            
            ALL_CHANNELS = ALL_CHANNELS.filter(chan => chan !== stdName);
            renderChannelLibrary();
            
            Object.keys(categoryData).forEach(catName => {
                categoryData[catName] = categoryData[catName].filter(chan => chan !== stdName);
            });
            renderCategories();
            
            renderMappings();
            
            alert(`已删除 "${stdName}" 的映射规则和频道库中的对应频道`);
        }

        function openAddMappingModal() {
            document.getElementById('addMappingModal').style.display = 'block';
            document.getElementById('newMappingName').value = '';
            document.getElementById('newMappingAliases').value = '';
        }

        function closeAddMappingModal() {
            document.getElementById('addMappingModal').style.display = 'none';
        }

        function saveNewMapping() {
            const newName = document.getElementById('newMappingName').value.trim();
            const aliasesStr = document.getElementById('newMappingAliases').value.trim();
            
            if (!newName) {
                alert('频道名称不能为空！');
                return;
            }
            
            if (!aliasesStr) {
                alert('至少添加一个别名！');
                return;
            }
            
            if (mappingData[newName]) {
                alert(`频道名称 "${newName}" 已存在！`);
                return;
            }
            
            const newAliases = aliasesStr.split(',').map(a => a.trim()).filter(a => a);
            const uniqueAliases = [...new Set(newAliases)];
            if (uniqueAliases.length !== newAliases.length) {
                alert('检测到重复别名，已自动去重');
            }
            
            mappingData[newName] = uniqueAliases;
            mappingChanged = true;

            if (!ALL_CHANNELS.includes(newName)) {
                ALL_CHANNELS.push(newName);
                renderChannelLibrary();
            }


            renderMappings();
            
            closeAddMappingModal();
            
            alert(`频道 "${newName}" 已添加到映射配置和频道库！`);
        }

        document.getElementById('save-all').addEventListener('click', async () => {
            const btn = document.getElementById('save-all');
            btn.disabled = true;
            btn.textContent = '保存中...';

            const configData = {
                categories: JSON.parse(JSON.stringify(categoryData)),
                mapping: JSON.parse(JSON.stringify(mappingData))
            };

            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });
                
                const data = await res.json();
                if (data.code === 200) {
                    alert('分类配置保存成功！');
                } else {
                    alert(`保存失败：${data.msg}`);
                }
            } catch (err) {
                alert('保存失败：请检查网络连接或后端服务');
                console.error('保存配置失败:', err);
            } finally {
                btn.disabled = false;
                btn.textContent = '保存IPTV频道配置';
            }
        });

        document.getElementById('save-mapping').addEventListener('click', async () => {
            const btn = document.getElementById('save-mapping');
            btn.disabled = true;
            btn.textContent = '保存中...';

            const configData = {
                categories: JSON.parse(JSON.stringify(categoryData)),
                mapping: JSON.parse(JSON.stringify(mappingData))
            };

            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });
                
                const data = await res.json();
                if (data.code === 200) {
                    alert('映射配置保存成功！');
                    mappingChanged = false;
                } else {
                    alert(`保存失败：${data.msg}`);
                }
            } catch (err) {
                alert('保存失败：请检查网络连接或后端服务');
                console.error('保存配置失败:', err);
            } finally {
                btn.disabled = false;
                btn.textContent = '保存映射配置';
            }
        });

        window.addEventListener('beforeunload', (e) => {
            if (mappingChanged) {
                e.preventDefault();
                e.returnValue = '你有未保存的映射配置变更，确定离开吗？';
                return e.returnValue;
            }
        });

        window.onclick = function(event) {
            const modal = document.getElementById('addMappingModal');
            if (event.target === modal) {
                closeAddMappingModal();
            }
        };
    </script>
</body>
</html>