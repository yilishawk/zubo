<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV频道配置 | kakaxi</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=-apple-system,BlinkMacSystemFont,San+Francisco,Helvetica+Neue,Helvetica,Arial,sans-serif">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        /* ====== 保留原来的CSS ====== */
        * {margin: 0;padding: 0;box-sizing: border-box;font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Helvetica Neue", Helvetica, Arial, sans-serif;-webkit-tap-highlight-color: rgba(0,0,0,0);}
        body {background-color: #f5f5f7;padding: 20px;color: #1d1d1f;}
        .container {max-width: 1000px;margin: 0 auto;display: flex;flex-direction: column;gap: 16px;}
        .panel-header {background-color: #ffffff;border-radius: 12px;padding: 16px 20px;box-shadow: 0 1px 3px rgba(0,0,0,0.05);text-align: center;}
        .panel-title {font-size: 20px;font-weight: 600;color: #1d1d1f;}
        .tab-group {display: flex;gap: 8px;background: #fff;padding: 8px;border-radius: 12px;box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
        .tab-btn {flex: 1;padding: 12px;border: none;border-radius: 8px;background: #f5f5f7;color: #86868b;font-size: 16px;font-weight: 500;cursor: pointer;transition: all 0.2s;}
        .tab-btn.active {background: #007aff;color: #fff;}
        #categories-container {display: flex;flex-direction: column;gap: 12px;cursor: grab;}
        #categories-container:active {cursor: grabbing;}
        .category-card {background: #ffffff;border-radius: 16px;padding: 18px;box-shadow: 0 2px 8px rgba(0,0,0,0.06);border: 1px solid transparent;transition: border 0.2s;}
        .category-card.active {border: 2px solid #007aff;}
        .category-header {display: flex;align-items: center;justify-content: space-between;margin-bottom: 12px;}
        .category-name-input {width: 220px;padding: 10px 14px;border: 1px solid #e5e5e7;border-radius: 10px;font-size: 16px;color: #1d1d1f;background-color: #f9f9fb;outline: none;cursor: text;}
        .category-name-input:focus {border-color: #007aff;}
        .btn-delete {padding: 8px 12px;border-radius: 8px;font-size: 14px;font-weight: 500;border: none;background-color: #ff3b30;color: #ffffff;cursor: pointer;}
        .channel-tags {display: flex;flex-wrap: wrap;gap: 8px;cursor: grab;}
        .channel-tags:active {cursor: grabbing;}
        .channel-tag {background-color: #e8f0fe;color: #007aff;padding: 8px 14px;border-radius: 20px;display: flex;align-items: center;gap: 8px;font-size: 14px;cursor: move;}
        .tag-close {cursor: pointer;font-size: 16px;line-height: 1;}
        .tag-close:hover {color: #ff3b30;}
        .global-channel-library {background: #ffffff;border-radius: 16px;padding: 12px 15px;box-shadow: 0 2px 8px rgba(0,0,0,0.06);}
        .library-title {font-size: 14px;color: #86868b;margin-bottom: 8px;font-weight: 400;}
        .preset-channels {display: flex;flex-wrap: wrap;gap: 3px;}
        .preset-channel {background-color: #f5f5f7;color: #1d1d1f;padding: 6px 10px;border-radius: 6px;font-size: 12px;cursor: pointer;transition: all 0.2s;line-height: 1.2;min-width: 60px;text-align: center;}
        .preset-channel:hover {background-color: #e8f0fe;color: #007aff;transform: translateY(-1px);}
        .btn-group {display: flex;gap: 12px;}
        .btn-add-category {flex: 1;padding: 14px;border-radius: 12px;font-size: 16px;font-weight: 500;border: 1px solid #007aff;background-color: #ffffff;color: #007aff;cursor: pointer;}
        .btn-save {flex: 2;padding: 14px;border-radius: 12px;font-size: 16px;font-weight: 500;border: none;background-color: #007aff;color: #ffffff;cursor: pointer;}
        .btn-save:disabled {background-color: #86868b;cursor: not-allowed;}
        #mapping-panel {display: none;}
        .mapping-card {background: #fff;border-radius: 16px;padding: 18px;box-shadow: 0 2px 8px rgba(0,0,0,0.06);margin-bottom: 12px;}
        .mapping-header {display: flex;align-items: center;justify-content: space-between;margin-bottom: 12px;}
        .standard-name-input {width: 220px;padding: 10px 14px;border: 1px solid #e5e5e7;border-radius: 10px;font-size: 16px;color: #1d1d1f;background-color: #f9f9fb;outline: none;cursor: text;}
        .standard-name-input:focus {border-color: #007aff;}
        .alias-tags {display: flex;flex-wrap: wrap;gap: 8px;margin-bottom: 12px;}
        .alias-tag {background-color: #f0f8ff;color: #0066cc;padding: 8px 14px;border-radius: 20px;display: flex;align-items: center;gap: 8px;font-size: 14px;}
        .alias-input-container {display: flex;gap: 8px;}
        .alias-input {flex: 1;padding: 10px 14px;border: 1px solid #e5e5e7;border-radius: 10px;font-size: 16px;outline: none;}
        .add-alias-btn {padding: 0 16px;border-radius: 10px;border: none;background: #007aff;color: #fff;font-size: 16px;cursor: pointer;}
        .btn-add-mapping {flex: 1;padding: 14px;border-radius: 12px;font-size: 16px;font-weight: 500;border: 1px solid #007aff;background-color: #ffffff;color: #007aff;cursor: pointer;}
        .modal {display: none;position: fixed;z-index: 1000;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgba(0,0,0,0.4);}
        .modal-content {background-color: #fefefe;margin: 15% auto;padding: 20px;border: 1px solid #888;border-radius: 12px;width: 80%;max-width: 400px;}
        .close {color: #aaa;float: right;font-size: 28px;font-weight: bold;cursor: pointer;}
        .close:hover, .close:focus {color: black;text-decoration: none;}
        .form-group {margin-bottom: 15px;}
        .form-group label {display: block;margin-bottom: 5px;font-weight: 500;}
        .form-group input, .form-group select {width: 100%;padding: 10px 14px;border: 1px solid #e5e5e7;border-radius: 10px;font-size: 16px;color: #1d1d1f;background-color: #f9f9fb;outline: none;}
        .modal-content button {width: 100%;padding: 12px;border-radius: 8px;border: none;background: #007aff;color: #fff;font-size: 16px;cursor: pointer;}
    </style>
</head>
<body>
    <div class="container">
        <div class="panel-header">
            <h1 class="panel-title">IPTV频道配置 | kakaxi</h1>
        </div>
        <div class="tab-group">
            <button class="tab-btn active" onclick="switchTab('category')">分类配置</button>
            <button class="tab-btn" onclick="switchTab('mapping')">映射配置</button>
        </div>

        <div id="category-panel">
            <div id="categories-container"></div>
            <div class="global-channel-library">
                <div class="library-title">频道库（单点添加）</div>
                <div class="preset-channels" id="preset-channels-container"></div>
            </div>
            <div class="btn-group">
                <button id="add-category" class="btn-add-category">添加分类</button>
                <button id="save-all" class="btn-save">保存IPTV频道配置</button>
            </div>
        </div>

        <div id="mapping-panel">
            <div id="mapping-container"></div>
            <div class="btn-group">
                <button id="add-mapping" class="btn-add-mapping" onclick="openAddMappingModal()">添加映射规则</button>
                <button id="save-mapping" class="btn-save">保存映射配置</button>
            </div>
        </div>
    </div>

    <div id="addMappingModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddMappingModal()">&times;</span>
            <h3 style="margin-bottom: 15px; text-align: center;">添加映射规则</h3>
            <div class="form-group">
                <label>频道名称（主名称）：</label>
                <input type="text" id="newMappingName" placeholder="标准名" required>
            </div>
            <div class="form-group">
                <label>别名（多个用英文逗号分隔）：</label>
                <input type="text" id="newMappingAliases" placeholder="别名" required>
            </div>
            <button onclick="saveNewMapping()">保存</button>
        </div>
    </div>

    <script>
        /* ====== JS逻辑 ====== */
        const CATEGORY_DATA = {/* 默认数据 */};
        const MAPPING_DATA = {/* 默认映射 */};
        let ALL_CHANNELS = [];
        Object.values(CATEGORY_DATA).forEach(chs => ALL_CHANNELS.push(...chs));
        ALL_CHANNELS = [...new Set(ALL_CHANNELS)];

        let categoryData = {...CATEGORY_DATA};
        let mappingData = {...MAPPING_DATA};
        let activeCategoryName = null;
        let mappingChanged = false;

        let categorySortable = null; // 分类拖拽实例
        let channelSortables = new Map(); // 每个分类频道拖拽实例

        window.onload = async function() {
            try {
                const res = await fetch('/api/config', { method: 'GET' });
                const data = await res.json();
                if (data.code === 200 && data.data) {
                    if (data.data.categories) categoryData = data.data.categories;
                    if (data.data.mapping) mappingData = data.data.mapping;
                    ALL_CHANNELS = [];
                    Object.values(categoryData).forEach(chs => ALL_CHANNELS.push(...chs));
                    ALL_CHANNELS = [...new Set(ALL_CHANNELS)];
                }
            } catch (err) { console.log('加载后端配置失败:', err); }

            renderCategories();
            renderChannelLibrary();
        };

        function initSortable() {
            if (!categorySortable) {
                categorySortable = new Sortable(document.getElementById('categories-container'), {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: () => {
                        const newData = {};
                        document.querySelectorAll('.category-card').forEach(card => {
                            const name = card.dataset.name;
                            newData[name] = categoryData[name];
                        });
                        categoryData = newData;
                    }
                });
            }

            // 初始化每个分类里的频道拖拽
            document.querySelectorAll('.category-card').forEach(card => {
                const catName = card.dataset.name;
                const tagsContainer = card.querySelector('.channel-tags');
                if (!channelSortables.has(catName)) {
                    const s = new Sortable(tagsContainer, {
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        onEnd: () => {
                            const newChs = [];
                            tagsContainer.querySelectorAll('.channel-tag').forEach(tag => {
                                newChs.push(tag.textContent.replace('×','').trim());
                            });
                            categoryData[catName] = newChs;
                        }
                    });
                    channelSortables.set(catName, s);
                }
            });
        }

        function renderCategories() {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';
            Object.entries(categoryData).forEach(([catName, channels]) => {
                const isActive = catName === activeCategoryName;
                const html = `
                    <div class="category-card ${isActive?'active':''}" data-name="${catName}">
                        <div class="category-header">
                            <input type="text" class="category-name-input" value="${catName}" placeholder="分类名" onchange="updateCategoryName('${catName}', this.value)">
                            <button class="btn-delete" onclick="deleteCategory('${catName}')">删除</button>
                        </div>
                        <div class="channel-tags">
                            ${channels.map(c => `<div class="channel-tag">${c} <span class="tag-close" onclick="removeChannelFromCategory('${catName}','${c}')">×</span></div>`).join('')}
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
            bindCategoryActiveEvent();
            setTimeout(() => initSortable(), 0);
        }

        function bindCategoryActiveEvent() {
            document.querySelectorAll('.category-card').forEach(card=>{
                card.onclick = (e)=>{
                    if(e.target.classList.contains('btn-delete') || e.target.classList.contains('category-name-input')) return;
                    document.querySelectorAll('.category-card').forEach(c=>c.classList.remove('active'));
                    card.classList.add('active');
                    activeCategoryName = card.dataset.name;
                };
            });
        }

        function updateCategoryName(oldName, newName) { /* 保留原逻辑 */ }
        function deleteCategory(catName) { /* 保留原逻辑 */ }
        function removeChannelFromCategory(catName, channelName) { /* 保留原逻辑 */ }
        document.getElementById('add-category').addEventListener('click', ()=>{ /* 保留原逻辑 */ });
        function renderChannelLibrary() { /* 保留原逻辑 */ }
        function addChannelToActiveCategory(channelName) { /* 保留原逻辑 */ }
        function switchTab(tab) { /* 保留原逻辑 */ }
        function renderMappings() { /* 保留原逻辑 */ }
        function addAlias(stdName) { /* 保留原逻辑 */ }
        function removeAlias(stdName, alias) { /* 保留原逻辑 */ }
        function updateStdName(oldName,newName) { /* 保留原逻辑 */ }
        function deleteMapping(stdName) { /* 保留原逻辑 */ }
        function openAddMappingModal() { /* 保留原逻辑 */ }
        function closeAddMappingModal() { /* 保留原逻辑 */ }
        function saveNewMapping() { /* 保留原逻辑 */ }

        document.getElementById('save-all').addEventListener('click', async ()=>{ /* 保留原逻辑 */ });
        document.getElementById('save-mapping').addEventListener('click', async ()=>{ /* 保留原逻辑 */ });
        window.addEventListener('beforeunload', e=>{ if(mappingChanged){ e.preventDefault(); e.returnValue='你有未保存的映射配置变更，确定离开吗？'; return e.returnValue; } });
        window.onclick = function(event){ const modal=document.getElementById('addMappingModal'); if(event.target===modal) closeAddMappingModal(); };
    </script>
</body>
</html>
