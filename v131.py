import asyncio
import aiohttp
import subprocess
import os
import re
import time
import threading
import datetime
from urllib.parse import urljoin
from flask import Flask, send_file, Response

# ================= ÈÖçÁΩÆ =================
PORT = 5000
UPDATE_INTERVAL = int(os.getenv("UPDATE_INTERVAL", 21600))
OUTPUT_FILE = "list.txt"
CONCURRENCY = 200
JSON_CONCURRENCY = 150
FFPROBE_CONCURRENCY = 10
MAX_SOURCES_PER_CHANNEL = 20
FFPROBE_TIMEOUT = 12

BASE_URLS = [
    "http://61.156.228.1:8154",
    "http://61.184.46.1:9901",
    "http://183.215.134.1:19901",
    "http://182.207.218.1:999",
    "http://36.36.200.1:44330",
    "http://111.221.137.1:44330",
    "http://120.238.94.1:9901",
    "http://1.198.30.1:9901",
    "http://1.198.67.1:9901",
    "http://1.199.234.1:9901",
    "http://1.199.235.1:9901",
    "http://101.65.32.1:9901",
    "http://101.66.199.1:9901",
    "http://106.46.34.1:9901",
    "http://106.55.164.1:9901",
    "http://110.189.180.1:9901",
    "http://111.8.224.1:8085",
    "http://112.123.218.1:9901",
    "http://112.123.219.1:9901",
    "http://112.132.160.1:9901",
    "http://112.193.114.1:9901",
    "http://112.234.23.1:9901",
    "http://113.220.232.1:9999",
    "http://113.220.233.1:9999",
    "http://113.220.234.1:9999",
    "http://113.220.235.1:9999",
    "http://113.223.12.1:9998",
    "http://113.236.30.1:9901",
    "http://113.245.217.1:9901",
    "http://113.245.218.1:9901",
    "http://115.207.24.1:9901",
    "http://115.215.143.1:9901",
    "http://115.220.17.1:9901",
    "http://115.224.206.1:9901",
    "http://116.227.232.1:7777",
    "http://116.233.34.1:7777",
    "http://116.30.121.1:8883",
    "http://116.31.165.1:280",
    "http://116.31.165.1:3079",
    "http://118.248.167.1:8088",
    "http://118.248.168.1:8088",
    "http://119.62.36.1:9901",
    "http://119.62.80.1:9901",
    "http://120.0.52.1:8086",
    "http://120.0.8.1:8086",
    "http://120.197.43.1:9901",
    "http://120.198.96.1:9901",
    "http://121.238.176.1:9901",
    "http://121.24.98.1:9901",
    "http://121.33.239.1:9901",
    "http://121.19.134.1:808",
    "http://122.4.92.1:9991",
    "http://123.10.69.1:9901",
    "http://123.10.70.1:9901",
    "http://123.10.71.1:9901",
    "http://123.101.144.1:9901",
    "http://123.183.24.1:6666",
    "http://123.183.25.1:6666",
    "http://123.183.27.1:6666",
    "http://123.189.36.1:9901",
    "http://123.235.8.1:9901",
    "http://123.4.125.1:9901",
    "http://123.52.12.1:9901",
    "http://123.54.171.1:9901",
    "http://123.54.220.1:9901",
    "http://123.55.3.1:9901",
    "http://123.7.110.1:9901",
    "http://123.9.47.1:9901",
    "http://124.238.110.1:9999",
    "http://124.66.82.1:9901",
    "http://124.90.211.1:9901",
    "http://124.94.193.1:9902",
    "http://125.106.86.1:9901",
    "http://125.107.177.1:9901",
    "http://125.107.97.1:9901",
    "http://125.114.210.1:9901",
    "http://125.114.241.1:9901",
    "http://125.115.210.1:9901",
    "http://125.119.48.1:9901",
    "http://125.125.129.1:9901",
    "http://125.125.133.1:9901",
    "http://125.125.134.1:9901",
    "http://125.42.150.1:9901",
    "http://125.42.151.1:9901",
    "http://125.43.240.1:9901",
    "http://125.43.244.1:9901",
    "http://125.43.247.1:9901",
    "http://125.43.249.1:9901",
    "http://150.255.145.1:9901",
    "http://150.255.149.1:9901",
    "http://150.255.150.1:9901",
    "http://150.255.157.1:9901",
    "http://150.255.216.1:9901",
    "http://153.0.204.1:9901",
    "http://163.177.122.1:9901",
    "http://171.104.198.1:8181",
    "http://171.106.217.1:8181",
    "http://171.108.239.1:8181",
    "http://171.12.189.1:9901",
    "http://171.14.89.1:9901",
    "http://171.35.124.1:10011",
    "http://171.38.194.1:8082",
    "http://171.8.75.1:8011",
    "http://180.113.102.1:5000",
    "http://180.117.149.1:9901",
    "http://180.124.146.1:60000",
    "http://180.175.163.1:7777",
    "http://180.213.174.1:9901",
    "http://182.117.136.1:9901",
    "http://182.117.90.1:9901",
    "http://182.120.229.1:9901",
    "http://182.122.122.1:9901",
    "http://182.122.73.1:10086",
    "http://182.125.172.1:9901",
    "http://182.126.114.1:9901",
    "http://183.10.180.1:9901",
    "http://183.10.181.1:9901",
    "http://202.168.187.1:9999",
    "http://210.22.75.1:9901",
    "http://218.13.170.1:9901",
    "http://218.29.147.1:9901",
    "http://218.71.245.1:9901",
    "http://218.74.169.1:9901",
    "http://218.74.171.1:9901",
    "http://220.180.109.1:9902",
    "http://220.180.112.1:9901",
    "http://220.180.229.1:9901",
    "http://220.202.98.1:14901",
    "http://220.248.173.1:9901",
    "http://221.205.131.1:9999",
    "http://221.206.104.1:9901",
    "http://221.213.69.1:9901",
    "http://221.213.94.1:9901",
    "http://222.140.9.1:9901",
    "http://222.142.198.1:9901",
    "http://222.142.72.1:9901",
    "http://222.142.73.1:9901",
    "http://222.142.93.1:9901",
    "http://222.169.70.1:9901",
    "http://222.92.7.1:3334",
    "http://223.151.51.1:9901",
    "http://223.159.11.1:8099",
    "http://223.159.8.1:8099",
    "http://223.159.9.1:8099",
    "http://223.166.234.1:7777",
    "http://223.199.83.1:9901",
    "http://223.241.247.1:9901",
    "http://223.243.10.1:9008",
    "http://36.49.56.1:9901",
    "http://36.99.134.1:9901",
    "http://36.99.206.1:9901",
    "http://39.152.171.1:9901",
    "http://39.164.202.1:8899",
    "http://39.164.222.1:888",
    "http://39.165.44.1:9901",
    "http://39.74.142.1:9999",
    "http://42.225.203.1:9901",
    "http://42.225.222.1:9901",
    "http://42.235.4.1:9901",
    "http://42.237.248.1:9901",
    "http://42.237.26.1:9901",
    "http://49.234.31.1:7033",
    "http://58.20.77.1:9002",
    "http://58.209.101.1:9901",
    "http://58.210.23.1:9901",
    "http://58.210.60.1:9901",
    "http://58.216.229.1:9901",
    "http://58.48.5.1:1111",
    "http://58.51.111.1:1111",
    "http://58.51.111.1:9901",
    "http://58.53.152.1:9901",
    "http://58.57.40.1:9901",
    "http://59.173.183.1:9901",
    "http://59.173.243.1:9901",
    "http://60.187.74.1:9901",
    "http://60.190.18.1:9901",
    "http://60.209.232.1:9901",
    "http://60.213.92.1:9901",
    "http://60.217.73.1:83",
    "http://60.255.137.1:9901",
    "http://60.255.47.1:8801",
    "http://60.255.47.1:9901",
    "http://60.4.9.1:9901",
    "http://61.130.72.1:8888",
    "http://61.136.172.1:9901",
    "http://61.136.67.1:50085",
    "http://61.138.128.1:19901",
]

JSON_PATHS = [
    "/iptv/live/1000.json?key=txiptv",
    "/iptv/live/1001.json?key=txiptv",
]

CHANNEL_CATEGORIES = {
    "Â§ÆËßÜÈ¢ëÈÅì": [
        "CCTV1", "CCTV2", "CCTV3", "CCTV4", "CCTV4Ê¨ßÊ¥≤", "CCTV4ÁæéÊ¥≤", "CCTV5", "CCTV5+", "CCTV6", "CCTV7",
        "CCTV8", "CCTV9", "CCTV10", "CCTV11", "CCTV12", "CCTV13", "CCTV14", "CCTV15", "CCTV16", "CCTV17",
        "ÂÖµÂô®ÁßëÊäÄ", "È£é‰∫ëÈü≥‰πê", "È£é‰∫ëË∂≥ÁêÉ", "È£é‰∫ëÂâßÂú∫", "ÊÄÄÊóßÂâßÂú∫", "Á¨¨‰∏ÄÂâßÂú∫", "Â•≥ÊÄßÊó∂Â∞ö", "‰∏ñÁïåÂú∞ÁêÜ", "Â§ÆËßÜÂè∞ÁêÉ", "È´òÂ∞îÂ§´ÁΩëÁêÉ",
        "Â§ÆËßÜÊñáÂåñÁ≤æÂìÅ", "Âç´ÁîüÂÅ•Â∫∑", "ÁîµËßÜÊåáÂçó", "ËÄÅÊïÖ‰∫ã", "‰∏≠Â≠¶Áîü", "ÂèëÁé∞‰πãÊóÖ", "‰π¶Ê≥ïÈ¢ëÈÅì", "ÂõΩÂ≠¶È¢ëÈÅì", "ÁéØÁêÉÂ•áËßÇ"
    ],
    "Âç´ËßÜÈ¢ëÈÅì": [
        "ÊπñÂçóÂç´ËßÜ", "ÊµôÊ±üÂç´ËßÜ", "Ê±üËãèÂç´ËßÜ", "‰∏úÊñπÂç´ËßÜ", "Ê∑±Âú≥Âç´ËßÜ", "Âåó‰∫¨Âç´ËßÜ", "Âπø‰∏úÂç´ËßÜ", "ÂπøË•øÂç´ËßÜ", "‰∏úÂçóÂç´ËßÜ", "Êµ∑ÂçóÂç´ËßÜ",
        "Ê≤≥ÂåóÂç´ËßÜ", "Ê≤≥ÂçóÂç´ËßÜ", "ÊπñÂåóÂç´ËßÜ", "Ê±üË•øÂç´ËßÜ", "ÂõõÂ∑ùÂç´ËßÜ", "ÈáçÂ∫ÜÂç´ËßÜ", "Ë¥µÂ∑ûÂç´ËßÜ", "‰∫ëÂçóÂç´ËßÜ", "Â§©Ê¥•Âç´ËßÜ", "ÂÆâÂæΩÂç´ËßÜ",
        "Â±±‰∏úÂç´ËßÜ", "ËæΩÂÆÅÂç´ËßÜ", "ÈªëÈæôÊ±üÂç´ËßÜ", "ÂêâÊûóÂç´ËßÜ", "ÂÜÖËíôÂè§Âç´ËßÜ", "ÂÆÅÂ§èÂç´ËßÜ", "Â±±Ë•øÂç´ËßÜ", "ÈôïË•øÂç´ËßÜ", "ÁîòËÇÉÂç´ËßÜ", "ÈùíÊµ∑Âç´ËßÜ",
        "Êñ∞ÁñÜÂç´ËßÜ", "Ë•øËóèÂç´ËßÜ", "‰∏âÊ≤ôÂç´ËßÜ", "ÂÖµÂõ¢Âç´ËßÜ", "Âª∂ËæπÂç´ËßÜ", "ÂÆâÂ§öÂç´ËßÜ", "Â∫∑Â∑¥Âç´ËßÜ", "ÂÜúÊûóÂç´ËßÜ", "Â±±‰∏úÊïôËÇ≤Âç´ËßÜ",
        "‰∏≠ÂõΩÊïôËÇ≤1Âè∞", "‰∏≠ÂõΩÊïôËÇ≤2Âè∞", "‰∏≠ÂõΩÊïôËÇ≤3Âè∞", "‰∏≠ÂõΩÊïôËÇ≤4Âè∞", "Êó©ÊúüÊïôËÇ≤"
    ],
    "Êï∞Â≠óÈ¢ëÈÅì": [
        "CHCÂä®‰ΩúÁîµÂΩ±", "CHCÂÆ∂Â∫≠ÂΩ±Èô¢", "CHCÂΩ±Ëø∑ÁîµÂΩ±", "Ê∑òÁîµÂΩ±", "Ê∑òÁ≤æÂΩ©", "Ê∑òÂâßÂú∫", "Ê∑ò4K", "Ê∑òÂ®±‰πê", "Ê∑òBABY", "Ê∑òËêåÂÆ†", "ÈáçÊ∏©ÁªèÂÖ∏",
        "ÊòüÁ©∫Âç´ËßÜ", "CHANNELV", "Âá§Âá∞Âç´ËßÜ‰∏≠ÊñáÂè∞", "Âá§Âá∞Âç´ËßÜËµÑËÆØÂè∞", "Âá§Âá∞Âç´ËßÜÈ¶ôÊ∏ØÂè∞", "Âá§Âá∞Âç´ËßÜÁîµÂΩ±Âè∞", "Ê±ÇÁ¥¢Á∫™ÂΩï", "Ê±ÇÁ¥¢ÁßëÂ≠¶",
        "Ê±ÇÁ¥¢ÁîüÊ¥ª", "Ê±ÇÁ¥¢Âä®Áâ©", "Á∫™ÂÆû‰∫∫Êñá", "ÈáëÈπ∞Á∫™ÂÆû", "Á∫™ÂÆûÁßëÊïô", "ÁùõÂΩ©ÈùíÂ∞ë", "ÁùõÂΩ©Á´ûÊäÄ", "ÁùõÂΩ©ÁØÆÁêÉ", "ÁùõÂΩ©ÂπøÂú∫Ëàû", "È≠ÖÂäõË∂≥ÁêÉ", "‰∫îÊòü‰ΩìËÇ≤",
        "Âä≤ÁàÜ‰ΩìËÇ≤", "Âø´‰πêÂûÇÈíì", "Ëå∂È¢ëÈÅì", "ÂÖàÈîã‰πíÁæΩ", "Â§©ÂÖÉÂõ¥Ê£ã", "Ê±ΩÊë©", "Ê¢®Âõ≠È¢ëÈÅì", "ÊñáÁâ©ÂÆùÂ∫ì", "Ê≠¶ÊúØ‰∏ñÁïå",
        "‰πêÊ∏∏", "ÁîüÊ¥ªÊó∂Â∞ö", "ÈÉΩÂ∏ÇÂâßÂú∫", "Ê¨¢Á¨ëÂâßÂú∫", "Ê∏∏ÊàèÈ£é‰∫ë", "ÈáëËâ≤Â≠¶Â†Ç", "Âä®Êº´ÁßÄÂú∫", "Êñ∞Âä®Êº´", "Âç°ÈÖ∑Â∞ëÂÑø", "ÈáëÈπ∞Âç°ÈÄö", "‰ºòÊº´Âç°ÈÄö", "ÂìàÂìàÁÇ´Âä®", "Âòâ‰Ω≥Âç°ÈÄö", 
        "‰∏≠ÂõΩ‰∫§ÈÄö", "‰∏≠ÂõΩÂ§©Ê∞î"
    ],
}

CHANNEL_MAPPING = {
    "CCTV1": ["CCTV-1", "CCTV1-ÁªºÂêà", "CCTV-1 ÁªºÂêà", "CCTV-1ÁªºÂêà", "CCTV1HD", "CCTV-1È´òÊ∏Ö", "CCTV-1HD", "cctv-1HD", "CCTV1ÁªºÂêàÈ´òÊ∏Ö", "cctv1"],
    "CCTV2": ["CCTV-2", "CCTV2-Ë¥¢Áªè", "CCTV-2 Ë¥¢Áªè", "CCTV-2Ë¥¢Áªè", "CCTV2HD", "CCTV-2È´òÊ∏Ö", "CCTV-2HD", "cctv-2HD", "CCTV2Ë¥¢ÁªèÈ´òÊ∏Ö", "cctv2"],
    "CCTV3": ["CCTV-3", "CCTV3-ÁªºËâ∫", "CCTV-3 ÁªºËâ∫", "CCTV-3ÁªºËâ∫", "CCTV3HD", "CCTV-3È´òÊ∏Ö", "CCTV-3HD", "cctv-3HD", "CCTV3ÁªºËâ∫È´òÊ∏Ö", "cctv3"],
    "CCTV4": ["CCTV-4", "CCTV4-ÂõΩÈôÖ", "CCTV-4 ‰∏≠ÊñáÂõΩÈôÖ", "CCTV-4‰∏≠ÊñáÂõΩÈôÖ", "CCTV4HD", "cctv4HD", "CCTV-4HD", "cctv-4HD", "CCTV4ÂõΩÈôÖÈ´òÊ∏Ö", "cctv4"],
    "CCTV4Ê¨ßÊ¥≤": ["CCTV-4Ê¨ßÊ¥≤", "CCTV-4Ê¨ßÊ¥≤", "CCTV4Ê¨ßÊ¥≤ HD", "CCTV-4 Ê¨ßÊ¥≤", "CCTV-4‰∏≠ÊñáÂõΩÈôÖÊ¨ßÊ¥≤", "CCTV4‰∏≠ÊñáÊ¨ßÊ¥≤", "CCTV4Ê¨ßÊ¥≤HD", "cctv4Ê¨ßÊ¥≤HD", "CCTV-4Ê¨ßÊ¥≤HD", "cctv-4Ê¨ßÊ¥≤HD"],
    "CCTV4ÁæéÊ¥≤": ["CCTV-4ÁæéÊ¥≤", "CCTV-4ÂåóÁæé", "CCTV4ÁæéÊ¥≤ HD", "CCTV-4 ÁæéÊ¥≤", "CCTV-4‰∏≠ÊñáÂõΩÈôÖÁæéÊ¥≤", "CCTV4‰∏≠ÊñáÁæéÊ¥≤", "CCTV4ÁæéÊ¥≤HD", "cctv4ÁæéÊ¥≤HD", "CCTV-4ÁæéÊ¥≤HD", "cctv-4ÁæéÊ¥≤HD"],
    "CCTV5": ["CCTV-5", "CCTV5-‰ΩìËÇ≤", "CCTV-5 ‰ΩìËÇ≤", "CCTV-5‰ΩìËÇ≤", "CCTV5HD", "CCTV-5È´òÊ∏Ö", "CCTV-5HD", "cctv-5HD", "CCTV5‰ΩìËÇ≤È´òÊ∏Ö", "cctv5"],
    "CCTV5+": ["CCTV-5+", "CCTV-5+ HD", "CCTV-5+ ‰ΩìËÇ≤Ëµõ‰∫ã", "CCTV5+‰ΩìËÇ≤Ëµõ‰∫ã", "CCTV5+HD", "CCTV-5+È´òÊ∏Ö", "CCTV-5+HD", "cctv-5+HD", "CCTV5plas", "CCTV5+‰ΩìËÇ≤ËµõËßÜÈ´òÊ∏Ö", "cctv5+"],
    "CCTV6": ["CCTV-6", "CCTV6-ÁîµÂΩ±", "CCTV-6 ÁîµÂΩ±", "CCTV-6ÁîµÂΩ±", "CCTV6HD", "CCTV-6È´òÊ∏Ö", "CCTV-6HD", "cctv-6HD", "CCTV6ÁîµÂΩ±È´òÊ∏Ö", "cctv6"],
    "CCTV7": ["CCTV-7", "CCTV7-ÂÜõÂÜú", "CCTV-7 ÂõΩÈò≤ÂÜõ‰∫ã", "CCTV-7ÂõΩÈò≤ÂÜõ‰∫ã", "CCTV7HD", "CCTV-7È´òÊ∏Ö", "CCTV-7HD", "cctv-7HD", "CCTV7ÂÜõ‰∫ãÈ´òÊ∏Ö", "cctv7"],
    "CCTV8": ["CCTV-8", "CCTV8-ÁîµËßÜÂâß", "CCTV-8 ÁîµËßÜÂâß", "CCTV-8ÁîµËßÜÂâß", "CCTV8HD", "CCTV-8È´òÊ∏Ö", "CCTV-8HD", "cctv-8HD", "CCTV8ÁîµËßÜÂâßÈ´òÊ∏Ö", "cctv8"],
    "CCTV9": ["CCTV-9", "CCTV9-Á∫™ÂΩï", "CCTV-9 Á∫™ÂΩï", "CCTV-9Á∫™ÂΩï", "CCTV9HD", "cctv9HD", "CCTV-9È´òÊ∏Ö", "cctv-9HD", "CCTV9ËÆ∞ÂΩïÈ´òÊ∏Ö", "cctv9"],
    "CCTV10": ["CCTV-10", "CCTV10-ÁßëÊïô", "CCTV-10 ÁßëÊïô", "CCTV-10ÁßëÊïô", "CCTV10HD", "CCTV-10È´òÊ∏Ö", "CCTV-10HD", "cctv-10HD", "CCTV10ÁßëÊïôÈ´òÊ∏Ö", "cctv10"],
    "CCTV11": ["CCTV-11", "CCTV11-ÊàèÊõ≤", "CCTV-11 ÊàèÊõ≤", "CCTV-11ÊàèÊõ≤", "CCTV11HD", "cctv11HD", "CCTV-11HD", "cctv-11HD", "CCTV11ÊàèÊõ≤È´òÊ∏Ö", "cctv11"],
    "CCTV12": ["CCTV-12", "CCTV12-Á§æ‰ºö‰∏éÊ≥ï", "CCTV-12 Á§æ‰ºö‰∏éÊ≥ï", "CCTV-12Á§æ‰ºö‰∏éÊ≥ï", "CCTV12HD", "CCTV-12È´òÊ∏Ö", "CCTV-12HD", "cctv-12HD", "CCTV12Á§æ‰ºö‰∏éÊ≥ïÈ´òÊ∏Ö", "cctv12"],
    "CCTV13": ["CCTV-13", "CCTV13-Êñ∞Èóª", "CCTV-13 Êñ∞Èóª", "CCTV-13Êñ∞Èóª", "CCTV13HD", "cctv13HD", "CCTV-13HD", "cctv-13HD", "CCTV13Êñ∞ÈóªÈ´òÊ∏Ö", "cctv13"],
    "CCTV14": ["CCTV-14", "CCTV14-Â∞ëÂÑø", "CCTV-14 Â∞ëÂÑø", "CCTV-14Â∞ëÂÑø", "CCTV14HD", "CCTV-14È´òÊ∏Ö", "CCTV-14HD", "cctv-14HD", "CCTV14Â∞ëÂÑøÈ´òÊ∏Ö", "cctv14"],
    "CCTV15": ["CCTV-15", "CCTV15-Èü≥‰πê", "CCTV-15 Èü≥‰πê", "CCTV-15Èü≥‰πê", "CCTV15HD", "cctv15HD", "CCTV-15HD", "cctv-15HD", "CCTV15Èü≥‰πêÈ´òÊ∏Ö", "cctv15"],
    "CCTV16": ["CCTV-16", "CCTV-16 HD", "CCTV-16 4K", "CCTV-16Â••ÊûóÂåπÂÖã", "CCTV16HD", "cctv16HD", "CCTV-16HD", "cctv-16HD", "CCTV16Â••ÊûóÂåπÂÖãÈ´òÊ∏Ö", "cctv16"],
    "CCTV17": ["CCTV-17", "CCTV17È´òÊ∏Ö", "CCTV17 HD", "CCTV-17ÂÜú‰∏öÂÜúÊùë", "CCTV17HD", "cctv17HD", "CCTV-17HD", "cctv-17HD", "CCTV17ÂÜú‰∏öÂÜúÊùëÈ´òÊ∏Ö", "cctv17"],
    "ÂÖµÂô®ÁßëÊäÄ": ["CCTV-ÂÖµÂô®ÁßëÊäÄ", "CCTVÂÖµÂô®ÁßëÊäÄ", "CCTVÂÖµÂô®ÁßëÊäÄHD"],
    "È£é‰∫ëÈü≥‰πê": ["CCTV-È£é‰∫ëÈü≥‰πê", "CCTVÈ£é‰∫ëÈü≥‰πê", "CCTVÈ£é‰∫ëÈü≥‰πêHD"],
    "Á¨¨‰∏ÄÂâßÂú∫": ["CCTV-Á¨¨‰∏ÄÂâßÂú∫", "CCTVÁ¨¨‰∏ÄÂâßÂú∫", "CCTVÁ¨¨‰∏ÄÂâßÂú∫HD"],
    "È£é‰∫ëË∂≥ÁêÉ": ["CCTV-È£é‰∫ëË∂≥ÁêÉ", "CCTVÈ£é‰∫ëË∂≥ÁêÉ", "CCTVÈ£é‰∫ëË∂≥ÁêÉHD"],
    "È£é‰∫ëÂâßÂú∫": ["CCTV-È£é‰∫ëÂâßÂú∫", "CCTVÈ£é‰∫ëÂâßÂú∫", "CCTVÈ£é‰∫ëÂâßÂú∫HD"],
    "ÊÄÄÊóßÂâßÂú∫": ["CCTV-ÊÄÄÊóßÂâßÂú∫", "CCTVÊÄÄÊóßÂâßÂú∫", "CCTVÊÄÄÊóßÂâßÂú∫HD"],
    "Â•≥ÊÄßÊó∂Â∞ö": ["CCTV-Â•≥ÊÄßÊó∂Â∞ö", "CCTVÂ•≥ÊÄßÊó∂Â∞ö", "CCTVÂ•≥ÊÄßÊó∂Â∞öHD"],
    "‰∏ñÁïåÂú∞ÁêÜ": ["CCTV-‰∏ñÁïåÂú∞ÁêÜ", "CCTV‰∏ñÁïåÂú∞ÁêÜ", "CCTV‰∏ñÁïåÂú∞ÁêÜHD"],
    "Â§ÆËßÜÂè∞ÁêÉ": ["CCTV-Â§ÆËßÜÂè∞ÁêÉ", "CCTVÂ§ÆËßÜÂè∞ÁêÉ", "CCTVÂ§ÆËßÜÂè∞ÁêÉHD"],
    "È´òÂ∞îÂ§´ÁΩëÁêÉ": ["CCTV-È´òÂ∞îÂ§´ÁΩëÁêÉ", "CCTVÈ´òÂ∞îÂ§´ÁΩëÁêÉ", "CCTVÂ§ÆËßÜÈ´òÁΩë", "CCTV-È´òÂ∞îÂ§´¬∑ÁΩëÁêÉ", "Â§ÆËßÜÈ´òÁΩë"],
    "Â§ÆËßÜÊñáÂåñÁ≤æÂìÅ": ["CCTV-Â§ÆËßÜÊñáÂåñÁ≤æÂìÅ", "CCTVÂ§ÆËßÜÊñáÂåñÁ≤æÂìÅ", "CCTVÊñáÂåñÁ≤æÂìÅ", "CCTV-ÊñáÂåñÁ≤æÂìÅ", "ÊñáÂåñÁ≤æÂìÅ"],
    "Âç´ÁîüÂÅ•Â∫∑": ["CCTV-Âç´ÁîüÂÅ•Â∫∑", "CCTVÂç´ÁîüÂÅ•Â∫∑"],
    "ÁîµËßÜÊåáÂçó": ["CCTV-ÁîµËßÜÊåáÂçó", "CCTVÁîµËßÜÊåáÂçó"],
    "ÂÜúÊûóÂç´ËßÜ": ["ÈôïË•øÂÜúÊûóÂç´ËßÜ"],
    "ÂÜÖËíôÂè§Âç´ËßÜ": ["ÂÜÖËíôÂè§", "ÂÜÖËíôÂç´ËßÜ"],
    "Â∫∑Â∑¥Âç´ËßÜ": ["ÂõõÂ∑ùÂ∫∑Â∑¥Âç´ËßÜ"],
    "Â±±‰∏úÊïôËÇ≤Âç´ËßÜ": ["Â±±‰∏úÊïôËÇ≤"],
    "‰∏≠ÂõΩÊïôËÇ≤1Âè∞": ["CETV1", "‰∏≠ÂõΩÊïôËÇ≤‰∏ÄÂè∞", "‰∏≠ÂõΩÊïôËÇ≤1", "CETV", "CETV-1", "‰∏≠ÂõΩÊïôËÇ≤"],
    "‰∏≠ÂõΩÊïôËÇ≤2Âè∞": ["CETV2", "‰∏≠ÂõΩÊïôËÇ≤‰∫åÂè∞", "‰∏≠ÂõΩÊïôËÇ≤2", "CETV-2 Á©∫‰∏≠ËØæÂ†Ç", "CETV-2"],
    "‰∏≠ÂõΩÊïôËÇ≤3Âè∞": ["CETV3", "‰∏≠ÂõΩÊïôËÇ≤‰∏âÂè∞", "‰∏≠ÂõΩÊïôËÇ≤3", "CETV-3 ÊïôËÇ≤ÊúçÂä°", "CETV-3"],
    "‰∏≠ÂõΩÊïôËÇ≤4Âè∞": ["CETV4", "‰∏≠ÂõΩÊïôËÇ≤ÂõõÂè∞", "‰∏≠ÂõΩÊïôËÇ≤4", "‰∏≠ÂõΩÊïôËÇ≤ÁîµËßÜÂè∞Á¨¨ÂõõÈ¢ëÈÅì", "CETV-4"],
    "‰∏úÂçóÂç´ËßÜ": ["Á¶èÂª∫‰∏úÂçó"],
    "CHCÂä®‰ΩúÁîµÂΩ±": ["CHCÂä®‰ΩúÁîµÂΩ±È´òÊ∏Ö"],
    "CHCÂÆ∂Â∫≠ÂΩ±Èô¢": ["CHCÂÆ∂Â∫≠ÁîµÂΩ±È´òÊ∏Ö"],
    "CHCÂΩ±Ëø∑ÁîµÂΩ±": ["CHCÈ´òÊ∏ÖÁîµÂΩ±", "CHC-ÂΩ±Ëø∑ÁîµÂΩ±", "ÂΩ±Ëø∑ÁîµÂΩ±", "chcÈ´òÊ∏ÖÁîµÂΩ±"],
    "Ê∑òÁîµÂΩ±": ["IPTVÊ∑òÁîµÂΩ±", "Âåó‰∫¨IPTVÊ∑òÁîµÂΩ±", "Âåó‰∫¨Ê∑òÁîµÂΩ±"],
    "Ê∑òÁ≤æÂΩ©": ["IPTVÊ∑òÁ≤æÂΩ©", "Âåó‰∫¨IPTVÊ∑òÁ≤æÂΩ©", "Âåó‰∫¨Ê∑òÁ≤æÂΩ©"],
    "Ê∑òÂâßÂú∫": ["IPTVÊ∑òÂâßÂú∫", "Âåó‰∫¨IPTVÊ∑òÂâßÂú∫", "Âåó‰∫¨Ê∑òÂâßÂú∫"],
    "Ê∑ò4K": ["IPTVÊ∑ò4K", "Âåó‰∫¨IPTV4KË∂ÖÊ∏Ö", "Âåó‰∫¨Ê∑ò4K", "Ê∑ò4K", "Ê∑ò 4K"],
    "Ê∑òÂ®±‰πê": ["IPTVÊ∑òÂ®±‰πê", "Âåó‰∫¨IPTVÊ∑òÂ®±‰πê", "Âåó‰∫¨Ê∑òÂ®±‰πê"],
    "Ê∑òBABY": ["IPTVÊ∑òBABY", "Âåó‰∫¨IPTVÊ∑òBABY", "Âåó‰∫¨Ê∑òBABY", "IPTVÊ∑òbaby", "Âåó‰∫¨IPTVÊ∑òbaby", "Âåó‰∫¨Ê∑òbaby"],
    "Ê∑òËêåÂÆ†": ["IPTVÊ∑òËêåÂÆ†", "Âåó‰∫¨IPTVËêåÂÆ†TV", "Âåó‰∫¨Ê∑òËêåÂÆ†"],
    "È≠ÖÂäõË∂≥ÁêÉ": ["‰∏äÊµ∑È≠ÖÂäõË∂≥ÁêÉ"],
    "ÁùõÂΩ©ÈùíÂ∞ë": ["ÁùõÂΩ©ÁæΩÊØõÁêÉ"],
    "Ê±ÇÁ¥¢Á∫™ÂΩï": ["Ê±ÇÁ¥¢ËÆ∞ÂΩï", "Ê±ÇÁ¥¢Á∫™ÂΩï4K", "Ê±ÇÁ¥¢ËÆ∞ÂΩï4K", "Ê±ÇÁ¥¢Á∫™ÂΩï 4K", "Ê±ÇÁ¥¢ËÆ∞ÂΩï 4K"],
    "ÈáëÈπ∞Á∫™ÂÆû": ["ÊπñÂçóÈáëÈπ∞Á∫™ÂÆû", "ÈáëÈπ∞ËÆ∞ÂÆû"],
    "Á∫™ÂÆûÁßëÊïô": ["Âåó‰∫¨Á∫™ÂÆûÁßëÊïô", "BRTVÁ∫™ÂÆûÁßëÊïô", "Âåó‰∫¨Á∫™ÂÆûÂç´ËßÜÈ´òÊ∏Ö"],
    "ÊòüÁ©∫Âç´ËßÜ": ["ÊòüÁ©∫Ë°õË¶ñ", "ÊòüÁ©∫Ë°õËßÜ", "ÊòüÁ©∫Âç´Ë¶ñ"],
    "CHANNELV": ["Channel [V]", "Channel[V]"],
    "Âá§Âá∞Âç´ËßÜ‰∏≠ÊñáÂè∞": ["Âá§Âá∞‰∏≠Êñá", "Âá§Âá∞‰∏≠ÊñáÂè∞", "Âá§Âá∞Âç´ËßÜ‰∏≠Êñá", "Âá§Âá∞Âç´ËßÜ"],
    "Âá§Âá∞Âç´ËßÜÈ¶ôÊ∏ØÂè∞": ["Âá§Âá∞È¶ôÊ∏ØÂè∞", "Âá§Âá∞Âç´ËßÜÈ¶ôÊ∏Ø", "Âá§Âá∞È¶ôÊ∏Ø"],
    "Âá§Âá∞Âç´ËßÜËµÑËÆØÂè∞": ["Âá§Âá∞ËµÑËÆØ", "Âá§Âá∞ËµÑËÆØÂè∞", "Âá§Âá∞Âí®ËØ¢", "Âá§Âá∞Âí®ËØ¢Âè∞", "Âá§Âá∞Âç´ËßÜÂí®ËØ¢Âè∞", "Âá§Âá∞Âç´ËßÜËµÑËÆØ", "Âá§Âá∞Âç´ËßÜÂí®ËØ¢"],
    "Âá§Âá∞Âç´ËßÜÁîµÂΩ±Âè∞": ["Âá§Âá∞ÁîµÂΩ±", "Âá§Âá∞ÁîµÂΩ±Âè∞", "Âá§Âá∞Âç´ËßÜÁîµÂΩ±", "È≥≥Âá∞Ë°õË¶ñÈõªÂΩ±Âè∞", "Âá§Âá∞ÁîµÂΩ±"],
    "Ëå∂È¢ëÈÅì": ["ÊπñÂçóËå∂È¢ëÈÅì", "ÊπñÂçóËå∂È¢ëÈÅìÈ´òÊ∏Ö", "Ëå∂È¢ëÈÅìÈ´òÊ∏Ö"],
    "Âø´‰πêÂûÇÈíì": ["ÊπñÂçóÂø´‰πêÂûÇÈíì", "ÊπñÂçóÂø´‰πêÂûÇÈíìÈ´òÊ∏Ö", "Âø´‰πêÂûÇÈíìÈ´òÊ∏Ö"],
    "ÂÖàÈîã‰πíÁæΩ": ["ÊπñÂçóÂÖàÈîã‰πíÁæΩ"],
    "Â§©ÂÖÉÂõ¥Ê£ã": ["Â§©ÂÖÉÂõ¥Ê£ãÈ¢ëÈÅì"],
    "Ê±ΩÊë©": ["ÈáçÂ∫ÜÊ±ΩÊë©", "Ê±ΩÊë©È¢ëÈÅì", "ÈáçÂ∫ÜÊ±ΩÊë©È¢ëÈÅì"],
    "Ê¢®Âõ≠È¢ëÈÅì": ["Ê≤≥ÂçóÊ¢®Âõ≠È¢ëÈÅì", "Ê¢®Âõ≠", "Ê≤≥ÂçóÊ¢®Âõ≠"],
    "ÊñáÁâ©ÂÆùÂ∫ì": ["Ê≤≥ÂçóÊñáÁâ©ÂÆùÂ∫ì"],
    "Ê≠¶ÊúØ‰∏ñÁïå": ["Ê≤≥ÂçóÊ≠¶ÊúØ‰∏ñÁïå"],
    "‰πêÊ∏∏": ["‰πêÊ∏∏È¢ëÈÅì", "‰∏äÊµ∑‰πêÊ∏∏È¢ëÈÅì", "‰πêÊ∏∏Á∫™ÂÆû", "SiTV‰πêÊ∏∏È¢ëÈÅì", "‰πêÊ∏∏È´òÊ∏Ö"],
    "Ê¨¢Á¨ëÂâßÂú∫": ["‰∏äÊµ∑Ê¨¢Á¨ëÂâßÂú∫4K", "Ê¨¢Á¨ëÂâßÂú∫ 4K", "Ê¨¢Á¨ëÂâßÂú∫È´òÊ∏Ö", "‰∏äÊµ∑Ê¨¢Á¨ëÂâßÂú∫"],
    "ÁîüÊ¥ªÊó∂Â∞ö": ["ÁîüÊ¥ªÊó∂Â∞ö4K", "SiTVÁîüÊ¥ªÊó∂Â∞ö", "‰∏äÊµ∑ÁîüÊ¥ªÊó∂Â∞ö", "ÁîüÊ¥ªÊó∂Â∞öÈ´òÊ∏Ö"],
    "ÈÉΩÂ∏ÇÂâßÂú∫": ["ÈÉΩÂ∏ÇÂâßÂú∫4K", "SiTVÈÉΩÂ∏ÇÂâßÂú∫", "‰∏äÊµ∑ÈÉΩÂ∏ÇÂâßÂú∫", "ÈÉΩÂ∏ÇÂâßÂú∫È´òÊ∏Ö"],
    "Ê∏∏ÊàèÈ£é‰∫ë": ["Ê∏∏ÊàèÈ£é‰∫ë4K", "SiTVÊ∏∏ÊàèÈ£é‰∫ë", "‰∏äÊµ∑Ê∏∏ÊàèÈ£é‰∫ë", "Ê∏∏ÊàèÈ£é‰∫ëÈ´òÊ∏Ö"],
    "ÈáëËâ≤Â≠¶Â†Ç": ["ÈáëËâ≤Â≠¶Â†Ç4K", "SiTVÈáëËâ≤Â≠¶Â†Ç", "‰∏äÊµ∑ÈáëËâ≤Â≠¶Â†Ç", "ÈáëËâ≤Â≠¶Â†ÇÈ´òÊ∏Ö"],
    "Âä®Êº´ÁßÄÂú∫": ["Âä®Êº´ÁßÄÂú∫4K", "SiTVÂä®Êº´ÁßÄÂú∫", "‰∏äÊµ∑Âä®Êº´ÁßÄÂú∫", "Âä®Êº´ÁßÄÂú∫È´òÊ∏Ö"],
    "Âç°ÈÖ∑Â∞ëÂÑø": ["Âåó‰∫¨KAKUÂ∞ëÂÑø", "BRTVÂç°ÈÖ∑Â∞ëÂÑø", "Âåó‰∫¨Âç°ÈÖ∑Â∞ëÂÑø", "Âç°ÈÖ∑Âä®Áîª", "Âåó‰∫¨Âç°ÈÄö", "Âåó‰∫¨Â∞ëÂÑø"],
    "ÂìàÂìàÁÇ´Âä®": ["ÁÇ´Âä®Âç°ÈÄö", "‰∏äÊµ∑ÂìàÂìàÁÇ´Âä®"],
    "‰ºòÊº´Âç°ÈÄö": ["Ê±üËãè‰ºòÊº´Âç°ÈÄö", "‰ºòÊº´Êº´Áîª"],
    "ÈáëÈπ∞Âç°ÈÄö": ["ÊπñÂçóÈáëÈπ∞Âç°ÈÄö"],
    "Âòâ‰Ω≥Âç°ÈÄö": ["‰Ω≥‰Ω≥Âç°ÈÄö"],
    "‰∏≠ÂõΩ‰∫§ÈÄö": ["‰∏≠ÂõΩ‰∫§ÈÄöÈ¢ëÈÅì", "‰∏≠ÂõΩ‰∫§ÈÄöHD"],
    "‰∏≠ÂõΩÂ§©Ê∞î": ["‰∏≠ÂõΩÂ§©Ê∞îÈ¢ëÈÅì", "‰∏≠ÂõΩÂ§©Ê∞îHD"],
}

app = Flask(__name__)

@app.route("/list.txt")
def serve_list():
    if not os.path.exists(OUTPUT_FILE):
        return Response("ËäÇÁõÆÂçïÁîüÊàê‰∏≠...\n", mimetype="text/plain")
    return send_file(OUTPUT_FILE, mimetype="text/plain")

def is_valid_stream(url: str) -> bool:
    if url.startswith(("rtp://", "udp://", "rtsp://")):
        return False
    if any(x in url for x in ("239.", "/paiptv/", "/00/SNM/", "/00/CHANNEL")):
        return False
    return any(ext in url for ext in (".m3u8", ".ts", ".flv", ".mp4"))

def generate_json_urls():
    urls = []
    for base in BASE_URLS:
        ip_start = base.find("//") + 2
        ip_end = base.find(":", ip_start)
        base_url = base[:ip_start]
        prefix = base[ip_start:ip_end].rsplit(".", 1)[0]
        port = base[ip_end:]

        for i in range(1, 256):
            for path in JSON_PATHS:
                urls.append(f"{base_url}{prefix}.{i}{port}{path}")
    return urls

async def check_json(session, url, sem):
    async with sem:
        try:
            async with session.get(url, timeout=2) as r:
                return url if r.status == 200 else None
        except:
            return None

async def fetch_channels(session, url, sem):
    async with sem:
        try:
            async with session.get(url, timeout=3) as r:
                data = await r.json()
                result = []
                for item in data.get("data", []):
                    name = item.get("name")
                    u = item.get("url")
                    if not name or not u or "," in u:
                        continue
                    if not u.startswith("http"):
                        u = urljoin(url, u)
                    result.append((name.strip(), u.strip()))
                return result
        except:
            return []

def normalize_name(name: str) -> str:
    n = name.strip()
    # ÂÖ®ËßíÁ¨¶Âè∑Áªü‰∏Ä
    n = n.replace("Ôºã", "+").replace("Ôºà", "(").replace("Ôºâ", ")")

    for std, aliases in CHANNEL_MAPPING.items():
        for a in aliases:
            a2 = a.replace("Ôºã", "+").replace("Ôºà", "(").replace("Ôºâ", ")")
            if n.lower() == a2.lower():
                return std
    return n

def group_by_channel(channels):
    grouped = {}
    for name, url in channels:
        grouped.setdefault(name, []).append(url)
    return grouped

async def probe_speed(url, sem):
    async with sem:
        start = time.time()
        try:
            proc = await asyncio.create_subprocess_exec(
                "ffprobe",
                "-v", "error",
                "-select_streams", "v:0",
                "-show_entries", "stream=codec_type",
                "-of", "default=nw=1",
                "-i", url,
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL
            )
            await asyncio.wait_for(proc.communicate(), timeout=FFPROBE_TIMEOUT)

            if proc.returncode == 0:
                return time.time() - start
            return None
        except:
            return None

async def measure_channel_sources(channel_dict):
    sem = asyncio.Semaphore(FFPROBE_CONCURRENCY)
    measured = {}

    for name, urls in channel_dict.items():
        # ‚ö†Ô∏è ÂÖ≥ÈîÆÔºöÂÖàË£ÅÂâ™ÔºåÂÜçÊµãÈÄü
        urls = urls[:MAX_SOURCES_PER_CHANNEL]

        tasks = [probe_speed(u, sem) for u in urls]
        speeds = await asyncio.gather(*tasks)

        valid = [
            (u, s) for u, s in zip(urls, speeds)
            if s is not None
        ]

        if valid:
            measured[name] = valid

    return measured

def write_list_atomic(grouped):
    now = datetime.datetime.now(
        datetime.timezone(datetime.timedelta(hours=8))
    ).strftime("%Y-%m-%d %H:%M:%S")

    tmp = OUTPUT_FILE + ".tmp"
    with open(tmp, "w", encoding="utf-8") as f:
        f.write("Êõ¥Êñ∞Êó∂Èó¥,#genre#\n")
        f.write(f"{now},https://kakaxi-1.asia/LOGO/Disclaimer.mp4\n\n")

        for cat, items in grouped.items():
            f.write(f"{cat},#genre#\n")
            for name, url in items:
                f.write(f"{name},{url}\n")
            f.write("\n")

    os.replace(tmp, OUTPUT_FILE)

async def generate_itvlist():
    async with aiohttp.ClientSession() as session:
        json_urls = generate_json_urls()

        sem = asyncio.Semaphore(JSON_CONCURRENCY)
        checked = await asyncio.gather(
            *[check_json(session, u, sem) for u in json_urls]
        )
        valid_jsons = [u for u in checked if u]

        raw = []
        for u in valid_jsons:
            raw.extend(await fetch_channels(session, u, sem))

        normalized = [
            (normalize_name(n), u)
            for n, u in raw
            if is_valid_stream(u)
        ]

        channel_dict = group_by_channel(normalized)

        measured = await measure_channel_sources(channel_dict)
        sorted_channels = {
            name: [u for u, _ in sorted(v, key=lambda x: x[1])]
            for name, v in measured.items()
        }

        grouped = {k: [] for k in CHANNEL_CATEGORIES}
        for cat, order in CHANNEL_CATEGORIES.items():
            for ch in order:
                for u in sorted_channels.get(ch, []):
                    grouped[cat].append((ch, u))

        write_list_atomic(grouped)

def background_loop():
    while True:
        try:
            print("üöÄ ÂºÄÂßãÁîüÊàêËäÇÁõÆÂçï")
            asyncio.run(generate_itvlist())
        except Exception as e:
            print("‚ö†Ô∏è Â§±Ë¥•:", e)
        time.sleep(UPDATE_INTERVAL)

if __name__ == "__main__":
    threading.Thread(target=background_loop, daemon=True).start()
    app.run(host="0.0.0.0", port=PORT, threaded=True)
